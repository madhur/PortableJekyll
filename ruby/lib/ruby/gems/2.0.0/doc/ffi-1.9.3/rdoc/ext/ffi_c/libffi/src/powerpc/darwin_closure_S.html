<!DOCTYPE html>

<html>
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">

<title>darwin_closure.S - ffi-1.9.3 Documentation</title>

<link type="text/css" media="screen" href="../../../../../rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "../../../../../";
</script>

<script type="text/javascript" charset="utf-8" src="../../../../../js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="../../../../../js/navigation.js"></script>
<script type="text/javascript" charset="utf-8" src="../../../../../js/search_index.js"></script>
<script type="text/javascript" charset="utf-8" src="../../../../../js/search.js"></script>
<script type="text/javascript" charset="utf-8" src="../../../../../js/searcher.js"></script>
<script type="text/javascript" charset="utf-8" src="../../../../../js/darkfish.js"></script>


<body class="file">
<nav id="metadata">
  <nav id="home-section" class="section">
  <h3 class="section-header">
    <a href="../../../../../index.html">Home</a>
    <a href="../../../../../table_of_contents.html#classes">Classes</a>
    <a href="../../../../../table_of_contents.html#methods">Methods</a>
  </h3>
</nav>


  <nav id="search-section" class="section project-section" class="initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <h3 class="section-header">
      <input type="text" name="search" placeholder="Search" id="search-field"
             title="Type to search, Up and Down to navigate, Enter to load">
    </h3>
  </form>

  <ul id="search-results" class="initially-hidden"></ul>
</nav>


  

  <div id="project-metadata">
    <nav id="fileindex-section" class="section project-section">
  <h3 class="section-header">Pages</h3>

  <ul>
  
    <li class="file"><a href="../../../../../ext/ffi_c/Makefile.html">Makefile</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/ffi_c-i386-mingw32_def.html">ffi_c-i386-mingw32.def</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi-i386-mingw32/Makefile.html">Makefile</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi-i386-mingw32/config_log.html">config.log</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi-i386-mingw32/config_status.html">config.status</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi-i386-mingw32/include/Makefile.html">Makefile</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi-i386-mingw32/libffi_la.html">libffi.la</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi-i386-mingw32/libffi_pc.html">libffi.pc</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi-i386-mingw32/libffi_convenience_la.html">libffi_convenience.la</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi-i386-mingw32/libtool.html">libtool</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi-i386-mingw32/man/Makefile.html">Makefile</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi-i386-mingw32/src/closures_lo.html">closures.lo</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi-i386-mingw32/src/debug_lo.html">debug.lo</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi-i386-mingw32/src/java_raw_api_lo.html">java_raw_api.lo</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi-i386-mingw32/src/prep_cif_lo.html">prep_cif.lo</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi-i386-mingw32/src/raw_api_lo.html">raw_api.lo</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi-i386-mingw32/src/types_lo.html">types.lo</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi-i386-mingw32/src/x86/ffi_lo.html">ffi.lo</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi-i386-mingw32/src/x86/win32_lo.html">win32.lo</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi-i386-mingw32/stamp-h1.html">stamp-h1</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi-i386-mingw32/testsuite/Makefile.html">Makefile</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/ChangeLog.html">ChangeLog</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/ChangeLog_libffi.html">ChangeLog.libffi</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/ChangeLog_libgcj.html">ChangeLog.libgcj</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/ChangeLog_v1.html">ChangeLog.v1</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/LICENSE.html">LICENSE</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/Makefile_am.html">Makefile.am</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/Makefile_in.html">Makefile.in</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/Makefile_vc.html">Makefile.vc</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/Makefile_vc64.html">Makefile.vc64</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/README.html">README</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/acinclude_m4.html">acinclude.m4</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/build-ios_sh.html">build-ios.sh</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/compile.html">compile</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/config_guess.html">config.guess</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/config_sub.html">config.sub</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/configure.html">configure</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/configure_ac.html">configure.ac</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/configure_host.html">configure.host</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/depcomp.html">depcomp</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/doc/libffi_info.html">libffi.info</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/doc/stamp-vti.html">stamp-vti</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/doc/version_texi.html">version.texi</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/fficonfig_h_in.html">fficonfig.h.in</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/include/Makefile_am.html">Makefile.am</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/include/Makefile_in.html">Makefile.in</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/install-sh.html">install-sh</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/libffi_pc_in.html">libffi.pc.in</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/libtool-version.html">libtool-version</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/ltmain_sh.html">ltmain.sh</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/m4/ax_cc_maxopt_m4.html">ax_cc_maxopt.m4</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/m4/ax_cflags_warn_all_m4.html">ax_cflags_warn_all.m4</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/m4/ax_check_compiler_flags_m4.html">ax_check_compiler_flags.m4</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/m4/ax_compiler_vendor_m4.html">ax_compiler_vendor.m4</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/m4/ax_configure_args_m4.html">ax_configure_args.m4</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/m4/ax_enable_builddir_m4.html">ax_enable_builddir.m4</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/m4/ax_gcc_archflag_m4.html">ax_gcc_archflag.m4</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/m4/ax_gcc_x86_cpuid_m4.html">ax_gcc_x86_cpuid.m4</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/man/Makefile_am.html">Makefile.am</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/man/Makefile_in.html">Makefile.in</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/man/ffi_3.html">ffi.3</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/man/ffi_call_3.html">ffi_call.3</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/man/ffi_prep_cif_3.html">ffi_prep_cif.3</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/mdate-sh.html">mdate-sh</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/missing.html">missing</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/msvcc_sh.html">msvcc.sh</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/src/alpha/osf_S.html">osf.S</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/src/arm/gentramp_sh.html">gentramp.sh</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/src/arm/sysv_S.html">sysv.S</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/src/arm/trampoline_S.html">trampoline.S</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/src/avr32/sysv_S.html">sysv.S</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/src/cris/sysv_S.html">sysv.S</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/src/frv/eabi_S.html">eabi.S</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/src/ia64/unix_S.html">unix.S</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/src/m32r/sysv_S.html">sysv.S</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/src/m68k/sysv_S.html">sysv.S</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/src/mips/n32_S.html">n32.S</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/src/mips/o32_S.html">o32.S</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/src/moxie/eabi_S.html">eabi.S</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/src/pa/hpux32_S.html">hpux32.S</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/src/pa/linux_S.html">linux.S</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/src/powerpc/aix_S.html">aix.S</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/src/powerpc/aix_closure_S.html">aix_closure.S</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/src/powerpc/darwin_S.html">darwin.S</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/src/powerpc/darwin_closure_S.html">darwin_closure.S</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/src/powerpc/linux64_S.html">linux64.S</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/src/powerpc/linux64_closure_S.html">linux64_closure.S</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/src/powerpc/ppc_closure_S.html">ppc_closure.S</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/src/powerpc/sysv_S.html">sysv.S</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/src/s390/sysv_S.html">sysv.S</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/src/sh/sysv_S.html">sysv.S</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/src/sh64/sysv_S.html">sysv.S</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/src/sparc/v8_S.html">v8.S</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/src/sparc/v9_S.html">v9.S</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/src/x86/darwin_S.html">darwin.S</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/src/x86/darwin64_S.html">darwin64.S</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/src/x86/freebsd_S.html">freebsd.S</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/src/x86/sysv_S.html">sysv.S</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/src/x86/unix64_S.html">unix64.S</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/src/x86/win32_S.html">win32.S</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/src/x86/win64_S.html">win64.S</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/testsuite/Makefile_am.html">Makefile.am</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/testsuite/Makefile_in.html">Makefile.in</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/testsuite/config/default_exp.html">default.exp</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/testsuite/lib/libffi-dg_exp.html">libffi-dg.exp</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/testsuite/lib/libffi_exp.html">libffi.exp</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/testsuite/lib/target-libpath_exp.html">target-libpath.exp</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/testsuite/lib/wrapper_exp.html">wrapper.exp</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/testsuite/libffi_call/call_exp.html">call.exp</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/testsuite/libffi_special/special_exp.html">special.exp</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/libffi/texinfo_tex.html">texinfo.tex</a>
  
    <li class="file"><a href="../../../../../ext/ffi_c/mkmf_log.html">mkmf.log</a>
  
    <li class="file"><a href="../../../../../lib/ffi/platform/arm-linux/types_conf.html">types.conf</a>
  
    <li class="file"><a href="../../../../../lib/ffi/platform/i386-cygwin/types_conf.html">types.conf</a>
  
    <li class="file"><a href="../../../../../lib/ffi/platform/i386-darwin/types_conf.html">types.conf</a>
  
    <li class="file"><a href="../../../../../lib/ffi/platform/i386-freebsd/types_conf.html">types.conf</a>
  
    <li class="file"><a href="../../../../../lib/ffi/platform/i386-gnu/types_conf.html">types.conf</a>
  
    <li class="file"><a href="../../../../../lib/ffi/platform/i386-linux/types_conf.html">types.conf</a>
  
    <li class="file"><a href="../../../../../lib/ffi/platform/i386-netbsd/types_conf.html">types.conf</a>
  
    <li class="file"><a href="../../../../../lib/ffi/platform/i386-openbsd/types_conf.html">types.conf</a>
  
    <li class="file"><a href="../../../../../lib/ffi/platform/i386-solaris/types_conf.html">types.conf</a>
  
    <li class="file"><a href="../../../../../lib/ffi/platform/i386-windows/types_conf.html">types.conf</a>
  
    <li class="file"><a href="../../../../../lib/ffi/platform/ia64-linux/types_conf.html">types.conf</a>
  
    <li class="file"><a href="../../../../../lib/ffi/platform/mips-linux/types_conf.html">types.conf</a>
  
    <li class="file"><a href="../../../../../lib/ffi/platform/mipsel-linux/types_conf.html">types.conf</a>
  
    <li class="file"><a href="../../../../../lib/ffi/platform/powerpc-aix/types_conf.html">types.conf</a>
  
    <li class="file"><a href="../../../../../lib/ffi/platform/powerpc-darwin/types_conf.html">types.conf</a>
  
    <li class="file"><a href="../../../../../lib/ffi/platform/powerpc-linux/types_conf.html">types.conf</a>
  
    <li class="file"><a href="../../../../../lib/ffi/platform/s390-linux/types_conf.html">types.conf</a>
  
    <li class="file"><a href="../../../../../lib/ffi/platform/s390x-linux/types_conf.html">types.conf</a>
  
    <li class="file"><a href="../../../../../lib/ffi/platform/sparc-linux/types_conf.html">types.conf</a>
  
    <li class="file"><a href="../../../../../lib/ffi/platform/sparc-solaris/types_conf.html">types.conf</a>
  
    <li class="file"><a href="../../../../../lib/ffi/platform/sparcv9-solaris/types_conf.html">types.conf</a>
  
    <li class="file"><a href="../../../../../lib/ffi/platform/x86_64-cygwin/types_conf.html">types.conf</a>
  
    <li class="file"><a href="../../../../../lib/ffi/platform/x86_64-darwin/types_conf.html">types.conf</a>
  
    <li class="file"><a href="../../../../../lib/ffi/platform/x86_64-freebsd/types_conf.html">types.conf</a>
  
    <li class="file"><a href="../../../../../lib/ffi/platform/x86_64-linux/types_conf.html">types.conf</a>
  
    <li class="file"><a href="../../../../../lib/ffi/platform/x86_64-netbsd/types_conf.html">types.conf</a>
  
    <li class="file"><a href="../../../../../lib/ffi/platform/x86_64-openbsd/types_conf.html">types.conf</a>
  
    <li class="file"><a href="../../../../../lib/ffi/platform/x86_64-solaris/types_conf.html">types.conf</a>
  
    <li class="file"><a href="../../../../../lib/ffi/platform/x86_64-windows/types_conf.html">types.conf</a>
  
  </ul>
</nav>

    <nav id="classindex-section" class="section project-section">
  <h3 class="section-header">Class and Module Index</h3>

  <ul class="link-list">
  
    <li><a href="../../../../../FFI.html">FFI</a>
  
    <li><a href="../../../../../FFI/AutoPointer.html">FFI::AutoPointer</a>
  
    <li><a href="../../../../../FFI/AutoPointer/CallableReleaser.html">FFI::AutoPointer::CallableReleaser</a>
  
    <li><a href="../../../../../FFI/AutoPointer/DefaultReleaser.html">FFI::AutoPointer::DefaultReleaser</a>
  
    <li><a href="../../../../../FFI/AutoPointer/Releaser.html">FFI::AutoPointer::Releaser</a>
  
    <li><a href="../../../../../FFI/ConstGenerator.html">FFI::ConstGenerator</a>
  
    <li><a href="../../../../../FFI/ConstGenerator/Constant.html">FFI::ConstGenerator::Constant</a>
  
    <li><a href="../../../../../FFI/Enum.html">FFI::Enum</a>
  
    <li><a href="../../../../../FFI/Enums.html">FFI::Enums</a>
  
    <li><a href="../../../../../FFI/Generator.html">FFI::Generator</a>
  
    <li><a href="../../../../../FFI/Generator/Task.html">FFI::Generator::Task</a>
  
    <li><a href="../../../../../FFI/IO.html">FFI::IO</a>
  
    <li><a href="../../../../../FFI/Library.html">FFI::Library</a>
  
    <li><a href="../../../../../FFI/ManagedStruct.html">FFI::ManagedStruct</a>
  
    <li><a href="../../../../../FFI/NotFoundError.html">FFI::NotFoundError</a>
  
    <li><a href="../../../../../FFI/Platform.html">FFI::Platform</a>
  
    <li><a href="../../../../../FFI/PlatformError.html">FFI::PlatformError</a>
  
    <li><a href="../../../../../FFI/Pointer.html">FFI::Pointer</a>
  
    <li><a href="../../../../../FFI/StrPtrConverter.html">FFI::StrPtrConverter</a>
  
    <li><a href="../../../../../FFI/Struct.html">FFI::Struct</a>
  
    <li><a href="../../../../../FFI/Struct/ManagedStructConverter.html">FFI::Struct::ManagedStructConverter</a>
  
    <li><a href="../../../../../FFI/StructGenerator.html">FFI::StructGenerator</a>
  
    <li><a href="../../../../../FFI/StructGenerator/Field.html">FFI::StructGenerator::Field</a>
  
    <li><a href="../../../../../FFI/StructLayout.html">FFI::StructLayout</a>
  
    <li><a href="../../../../../FFI/StructLayout/Enum.html">FFI::StructLayout::Enum</a>
  
    <li><a href="../../../../../FFI/StructLayout/InnerStruct.html">FFI::StructLayout::InnerStruct</a>
  
    <li><a href="../../../../../FFI/StructLayout/Mapped.html">FFI::StructLayout::Mapped</a>
  
    <li><a href="../../../../../FFI/StructLayoutBuilder.html">FFI::StructLayoutBuilder</a>
  
    <li><a href="../../../../../FFI/Type.html">FFI::Type</a>
  
    <li><a href="../../../../../FFI/TypesGenerator.html">FFI::TypesGenerator</a>
  
    <li><a href="../../../../../FFI/Union.html">FFI::Union</a>
  
    <li><a href="../../../../../FFI/VariadicInvoker.html">FFI::VariadicInvoker</a>
  
    <li><a href="../../../../../RbConfig.html">RbConfig</a>
  
  </ul>
</nav>

  </div>
</nav>

<div id="documentation" class="description">
  
<pre>-----------------------------------------------------------------------
darwin_closure.S - Copyright (c) 2002, 2003, 2004, 2010, 
Free Software Foundation, Inc. 
based on ppc_closure.S

PowerPC Assembly glue.

Permission is hereby granted, free of charge, to any person obtaining
a copy of this software and associated documentation files (the
``Software&#39;&#39;), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:

The above copyright notice and this permission notice shall be included
in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED ``AS IS&#39;&#39;, WITHOUT WARRANTY OF ANY KIND, EXPRESS
OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY CLAIM, DAMAGES OR
OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
OTHER DEALINGS IN THE SOFTWARE.
-----------------------------------------------------------------------</pre>

<p>define LIBFFI_ASM define L(x) x</p>

<p>if defined(<em>ppc64</em>) define MODE_CHOICE(x, y) y else define
MODE_CHOICE(x, y) x endif</p>

<p>define machine_choice  MODE_CHOICE(ppc7400,ppc64)</p>

<p>; Define some pseudo-opcodes for size-independent load &amp; store of GPRs
… define lgu             MODE_CHOICE(lwzu, ldu) define lg             
MODE_CHOICE(lwz,ld) define sg              MODE_CHOICE(stw,std) define sgu 
MODE_CHOICE(stwu,stdu)</p>

<p>; … and the size of GPRs and their storage indicator. define GPR_BYTES     
MODE_CHOICE(4,8) define LOG2_GPR_BYTES  MODE_CHOICE(2,3)          
log2(GPR_BYTES)</p>

<p>define g_long          MODE_CHOICE(long, quad) /* usage is “.g_long” */</p>

<p>; From the ABI doc: “Mac OS X ABI Function Call Guide” Version 2009-02-04.
define LINKAGE_SIZE    MODE_CHOICE(24,48) define PARAM_AREA     
MODE_CHOICE(32,64)</p>

<p>define SAVED_CR_OFFSET MODE_CHOICE(4,8)        /* save position for CR */
define SAVED_LR_OFFSET MODE_CHOICE(8,16)       /* save position for lr */</p>

<p>/* WARNING: if ffi_type is changed… here be monsters.</p>

<pre>Offsets of items within the result type.  */</pre>

<p>define FFI_TYPE_TYPE   MODE_CHOICE(6,10) define FFI_TYPE_ELEM  
MODE_CHOICE(8,16)</p>

<p>define SAVED_FPR_COUNT 13 define FPR_SIZE        8 /* biggest m64 struct
ret is 8GPRS + 13FPRS = 168 bytes - rounded to 16bytes = 176. */ define
RESULT_BYTES    MODE_CHOICE(16,176)</p>

<p>; The whole stack frame *<strong>MUST</strong>* be 16byte-aligned. define
SAVE_SIZE
(((LINKAGE_SIZE+PARAM_AREA+SAVED_FPR_COUNT*FPR_SIZE+RESULT_BYTES)+15) &amp;
-16LL) define PAD_SIZE
(SAVE_SIZE-(LINKAGE_SIZE+PARAM_AREA+SAVED_FPR_COUNT*FPR_SIZE+RESULT_BYTES))</p>

<p>define PARENT_PARM_BASE (SAVE_SIZE+LINKAGE_SIZE) define FP_SAVE_BASE
(LINKAGE_SIZE+PARAM_AREA)</p>

<p>if defined(<em>ENVIRONMENT_MAC_OS_X_VERSION_MIN_REQUIRED</em>) &amp;&amp;
<em>ENVIRONMENT_MAC_OS_X_VERSION_MIN_REQUIRED</em> &gt;= 1050 ; We no
longer need the pic symbol stub for Darwin &gt;= 9. define BLCLS_HELP
_ffi_closure_helper_DARWIN define STRUCT_RETVALUE_P
_darwin64_struct_ret_by_value_p define PASS_STR_FLOATS
_darwin64_pass_struct_floats undef WANT_STUB else define BLCLS_HELP
L_ffi_closure_helper_DARWIN$stub define STRUCT_RETVALUE_P
L_darwin64_struct_ret_by_value_p$stub define PASS_STR_FLOATS
L_darwin64_pass_struct_floats$stub define WANT_STUB endif</p>

<p>/* m32/m64</p>

<pre>  The stack layout looks like this:

  |   Additional params...                     | |     Higher address
  ~                                            ~ ~
  |   Parameters      (at least 8*4/8=32/64)   | | NUM_GPR_ARG_REGISTERS
  |--------------------------------------------| |
  |   TOC=R2 (AIX) Reserved (Darwin)   4/8     | |
  |--------------------------------------------| |
  |   Reserved                       2*4/8     | |
  |--------------------------------------------| |
  |   Space for callee`s LR            4/8     | |
  |--------------------------------------------| |
  |   Saved CR [low word for m64]      4/8     | |
  |--------------------------------------------| |
  |   Current backchain pointer        4/8     |-/ Parent`s frame.
  |--------------------------------------------| &lt;+ &lt;&lt;&lt; on entry to
  |   Result Bytes                    16/176   | |
  |--------------------------------------------| |
  ~   padding to 16-byte alignment             ~ ~
  |--------------------------------------------| |
  |   NUM_FPR_ARG_REGISTERS slots              | |
  |   here fp13 .. fp1                13*8     | |
  |--------------------------------------------| |
  |   R3..R10                    8*4/8=32/64   | | NUM_GPR_ARG_REGISTERS
  |--------------------------------------------| |
  |   TOC=R2 (AIX) Reserved (Darwin)   4/8     | |
  |--------------------------------------------| |     stack   |
  |   Reserved [compiler,binder]     2*4/8     | |     grows   |
  |--------------------------------------------| |     down    V
  |   Space for callees LR             4/8     | |
  |--------------------------------------------| |     lower addresses
  |   Saved CR [low word for m64]      4/8     | |
  |--------------------------------------------| |     stack pointer here
  |   Current backchain pointer        4/8     |-/     during
  |--------------------------------------------|   &lt;&lt;&lt; call.

/

       .file   &quot;darwin_closure.S&quot;

       .machine machine_choice

       .text
       .globl _ffi_closure_ASM
       .align LOG2_GPR_BYTES</pre>

<p>_ffi_closure_ASM: LFB1: Lstartcode:</p>

<pre>mflr    r0                      /* extract return address  */
sg      r0,SAVED_LR_OFFSET(r1)  /* save the return address  */</pre>

<p>LCFI0:</p>

<pre>sgu     r1,-SAVE_SIZE(r1)       /* skip over caller save area
                                keep stack aligned to 16.  */</pre>

<p>LCFI1:</p>

<pre class="ruby"><span class="ruby-regexp">/* We want to build up an area for the parameters passed
   in registers. (both floating point and integer)  */</span>

<span class="ruby-regexp">/* Put gpr 3 to gpr 10 in the parents outgoing area...
   ... the remainder of any params that overflowed the regs will
   follow here.  */</span>
<span class="ruby-identifier">sg</span>      <span class="ruby-identifier">r3</span>, (<span class="ruby-constant">PARENT_PARM_BASE</span>                )(<span class="ruby-identifier">r1</span>)
<span class="ruby-identifier">sg</span>      <span class="ruby-identifier">r4</span>, (<span class="ruby-constant">PARENT_PARM_BASE</span> <span class="ruby-operator">+</span> <span class="ruby-constant">GPR_BYTES</span>    )(<span class="ruby-identifier">r1</span>)
<span class="ruby-identifier">sg</span>      <span class="ruby-identifier">r5</span>, (<span class="ruby-constant">PARENT_PARM_BASE</span> <span class="ruby-operator">+</span> <span class="ruby-constant">GPR_BYTES</span> <span class="ruby-operator">*</span> <span class="ruby-value">2</span>)(<span class="ruby-identifier">r1</span>)
<span class="ruby-identifier">sg</span>      <span class="ruby-identifier">r6</span>, (<span class="ruby-constant">PARENT_PARM_BASE</span> <span class="ruby-operator">+</span> <span class="ruby-constant">GPR_BYTES</span> <span class="ruby-operator">*</span> <span class="ruby-value">3</span>)(<span class="ruby-identifier">r1</span>)
<span class="ruby-identifier">sg</span>      <span class="ruby-identifier">r7</span>, (<span class="ruby-constant">PARENT_PARM_BASE</span> <span class="ruby-operator">+</span> <span class="ruby-constant">GPR_BYTES</span> <span class="ruby-operator">*</span> <span class="ruby-value">4</span>)(<span class="ruby-identifier">r1</span>)
<span class="ruby-identifier">sg</span>      <span class="ruby-identifier">r8</span>, (<span class="ruby-constant">PARENT_PARM_BASE</span> <span class="ruby-operator">+</span> <span class="ruby-constant">GPR_BYTES</span> <span class="ruby-operator">*</span> <span class="ruby-value">5</span>)(<span class="ruby-identifier">r1</span>)
<span class="ruby-identifier">sg</span>      <span class="ruby-identifier">r9</span>, (<span class="ruby-constant">PARENT_PARM_BASE</span> <span class="ruby-operator">+</span> <span class="ruby-constant">GPR_BYTES</span> <span class="ruby-operator">*</span> <span class="ruby-value">6</span>)(<span class="ruby-identifier">r1</span>)
<span class="ruby-identifier">sg</span>      <span class="ruby-identifier">r10</span>,(<span class="ruby-constant">PARENT_PARM_BASE</span> <span class="ruby-operator">+</span> <span class="ruby-constant">GPR_BYTES</span> <span class="ruby-operator">*</span> <span class="ruby-value">7</span>)(<span class="ruby-identifier">r1</span>)

<span class="ruby-regexp">/* We save fpr 1 to fpr 14 in our own save frame.  */</span>
<span class="ruby-identifier">stfd</span>    <span class="ruby-identifier">f1</span>, (<span class="ruby-constant">FP_SAVE_BASE</span>                 )(<span class="ruby-identifier">r1</span>)
<span class="ruby-identifier">stfd</span>    <span class="ruby-identifier">f2</span>, (<span class="ruby-constant">FP_SAVE_BASE</span> <span class="ruby-operator">+</span>  <span class="ruby-constant">FPR_SIZE</span>     )(<span class="ruby-identifier">r1</span>)
<span class="ruby-identifier">stfd</span>    <span class="ruby-identifier">f3</span>, (<span class="ruby-constant">FP_SAVE_BASE</span> <span class="ruby-operator">+</span>  <span class="ruby-constant">FPR_SIZE</span> <span class="ruby-operator">*</span> <span class="ruby-value">2</span> )(<span class="ruby-identifier">r1</span>)
<span class="ruby-identifier">stfd</span>    <span class="ruby-identifier">f4</span>, (<span class="ruby-constant">FP_SAVE_BASE</span> <span class="ruby-operator">+</span>  <span class="ruby-constant">FPR_SIZE</span> <span class="ruby-operator">*</span> <span class="ruby-value">3</span> )(<span class="ruby-identifier">r1</span>)
<span class="ruby-identifier">stfd</span>    <span class="ruby-identifier">f5</span>, (<span class="ruby-constant">FP_SAVE_BASE</span> <span class="ruby-operator">+</span>  <span class="ruby-constant">FPR_SIZE</span> <span class="ruby-operator">*</span> <span class="ruby-value">4</span> )(<span class="ruby-identifier">r1</span>)
<span class="ruby-identifier">stfd</span>    <span class="ruby-identifier">f6</span>, (<span class="ruby-constant">FP_SAVE_BASE</span> <span class="ruby-operator">+</span>  <span class="ruby-constant">FPR_SIZE</span> <span class="ruby-operator">*</span> <span class="ruby-value">5</span> )(<span class="ruby-identifier">r1</span>)
<span class="ruby-identifier">stfd</span>    <span class="ruby-identifier">f7</span>, (<span class="ruby-constant">FP_SAVE_BASE</span> <span class="ruby-operator">+</span>  <span class="ruby-constant">FPR_SIZE</span> <span class="ruby-operator">*</span> <span class="ruby-value">6</span> )(<span class="ruby-identifier">r1</span>)
<span class="ruby-identifier">stfd</span>    <span class="ruby-identifier">f8</span>, (<span class="ruby-constant">FP_SAVE_BASE</span> <span class="ruby-operator">+</span>  <span class="ruby-constant">FPR_SIZE</span> <span class="ruby-operator">*</span> <span class="ruby-value">7</span> )(<span class="ruby-identifier">r1</span>)
<span class="ruby-identifier">stfd</span>    <span class="ruby-identifier">f9</span>, (<span class="ruby-constant">FP_SAVE_BASE</span> <span class="ruby-operator">+</span>  <span class="ruby-constant">FPR_SIZE</span> <span class="ruby-operator">*</span> <span class="ruby-value">8</span> )(<span class="ruby-identifier">r1</span>)
<span class="ruby-identifier">stfd</span>    <span class="ruby-identifier">f10</span>,(<span class="ruby-constant">FP_SAVE_BASE</span> <span class="ruby-operator">+</span>  <span class="ruby-constant">FPR_SIZE</span> <span class="ruby-operator">*</span> <span class="ruby-value">9</span> )(<span class="ruby-identifier">r1</span>)
<span class="ruby-identifier">stfd</span>    <span class="ruby-identifier">f11</span>,(<span class="ruby-constant">FP_SAVE_BASE</span> <span class="ruby-operator">+</span>  <span class="ruby-constant">FPR_SIZE</span> <span class="ruby-operator">*</span> <span class="ruby-value">10</span>)(<span class="ruby-identifier">r1</span>)
<span class="ruby-identifier">stfd</span>    <span class="ruby-identifier">f12</span>,(<span class="ruby-constant">FP_SAVE_BASE</span> <span class="ruby-operator">+</span>  <span class="ruby-constant">FPR_SIZE</span> <span class="ruby-operator">*</span> <span class="ruby-value">11</span>)(<span class="ruby-identifier">r1</span>)
<span class="ruby-identifier">stfd</span>    <span class="ruby-identifier">f13</span>,(<span class="ruby-constant">FP_SAVE_BASE</span> <span class="ruby-operator">+</span>  <span class="ruby-constant">FPR_SIZE</span> <span class="ruby-operator">*</span> <span class="ruby-value">12</span>)(<span class="ruby-identifier">r1</span>)

<span class="ruby-regexp">/* Set up registers for the routine that actually does the work
   get the context pointer from the trampoline.  */</span>
<span class="ruby-identifier">mr</span>      <span class="ruby-identifier">r3</span>,<span class="ruby-identifier">r11</span>

<span class="ruby-regexp">/* Now load up the pointer to the result storage.  */</span>
<span class="ruby-identifier">addi</span>    <span class="ruby-identifier">r4</span>,<span class="ruby-identifier">r1</span>,(<span class="ruby-constant">SAVE_SIZE</span><span class="ruby-operator">-</span><span class="ruby-constant">RESULT_BYTES</span>)

<span class="ruby-regexp">/* Now load up the pointer to the saved gpr registers.  */</span>
<span class="ruby-identifier">addi</span>    <span class="ruby-identifier">r5</span>,<span class="ruby-identifier">r1</span>,<span class="ruby-constant">PARENT_PARM_BASE</span>

<span class="ruby-regexp">/* Now load up the pointer to the saved fpr registers.  */</span>
<span class="ruby-identifier">addi</span>    <span class="ruby-identifier">r6</span>,<span class="ruby-identifier">r1</span>,<span class="ruby-constant">FP_SAVE_BASE</span>

<span class="ruby-regexp">/* Make the call.  */</span>
<span class="ruby-identifier">bl</span>      <span class="ruby-constant">BLCLS_HELP</span>

<span class="ruby-regexp">/* r3 contains the rtype pointer... save it since we will need
   it later.  */</span>
<span class="ruby-identifier">sg</span>      <span class="ruby-identifier">r3</span>,<span class="ruby-constant">LINKAGE_SIZE</span>(<span class="ruby-identifier">r1</span>)     ; <span class="ruby-identifier">ffi_type</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">result_type</span>
<span class="ruby-identifier">lg</span>      <span class="ruby-identifier">r0</span>,<span class="ruby-value">0</span>(<span class="ruby-identifier">r3</span>)                ; <span class="ruby-identifier">size</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">r0</span>
<span class="ruby-identifier">lhz</span>     <span class="ruby-identifier">r3</span>,<span class="ruby-constant">FFI_TYPE_TYPE</span>(<span class="ruby-identifier">r3</span>)    ; <span class="ruby-identifier">type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">r3</span>

<span class="ruby-regexp">/* The helper will have intercepted struture returns and inserted
   the caller`s destination address for structs returned by ref.  */</span>

<span class="ruby-regexp">/* r3 contains the return type  so use it to look up in a table
   so we know how to deal with each type.  */</span>

<span class="ruby-identifier">addi</span>    <span class="ruby-identifier">r5</span>,<span class="ruby-identifier">r1</span>,(<span class="ruby-constant">SAVE_SIZE</span><span class="ruby-operator">-</span><span class="ruby-constant">RESULT_BYTES</span>) <span class="ruby-operator">/</span><span class="ruby-operator">*</span> <span class="ruby-constant">Otherwise</span>, <span class="ruby-identifier">our</span> <span class="ruby-keyword">return</span> <span class="ruby-identifier">is</span> <span class="ruby-identifier">here</span>.  <span class="ruby-operator">*</span><span class="ruby-operator">/</span>
<span class="ruby-identifier">bl</span>      <span class="ruby-constant">Lget_ret_type0_addr</span>     <span class="ruby-regexp">/* Get pointer to Lret_type0 into LR.  */</span>
<span class="ruby-identifier">mflr</span>    <span class="ruby-identifier">r4</span>                      <span class="ruby-regexp">/* Move to r4.  */</span>
<span class="ruby-identifier">slwi</span>    <span class="ruby-identifier">r3</span>,<span class="ruby-identifier">r3</span>,<span class="ruby-value">4</span>                 <span class="ruby-operator">/</span><span class="ruby-operator">*</span> <span class="ruby-constant">Now</span> <span class="ruby-identifier">multiply</span> <span class="ruby-keyword">return</span> <span class="ruby-identifier">type</span> <span class="ruby-identifier">by</span> <span class="ruby-value">16</span>.  <span class="ruby-operator">*</span><span class="ruby-operator">/</span>
<span class="ruby-identifier">add</span>     <span class="ruby-identifier">r3</span>,<span class="ruby-identifier">r3</span>,<span class="ruby-identifier">r4</span>                <span class="ruby-regexp">/* Add contents of table to table address.  */</span>
<span class="ruby-identifier">mtctr</span>   <span class="ruby-identifier">r3</span>
<span class="ruby-identifier">bctr</span>                             <span class="ruby-regexp">/* Jump to it.  */</span>
</pre>

<p>LFE1: /* Each of the ret_typeX code fragments has to be exactly 16 bytes
long</p>

<pre>(4 instructions). For cache effectiveness we align to a 16 byte boundary
first.  */

     .align 4

     nop
     nop
     nop</pre>

<p>Lget_ret_type0_addr:</p>

<pre>blrl</pre>

<p>/* case FFI_TYPE_VOID  */ Lret_type0:</p>

<pre>b       Lfinish
nop
nop
nop</pre>

<p>/* case FFI_TYPE_INT  */ Lret_type1:</p>

<pre>lg      r3,0(r5)
b       Lfinish
nop
nop</pre>

<p>/* case FFI_TYPE_FLOAT  */ Lret_type2:</p>

<pre>lfs     f1,0(r5)
b       Lfinish
nop
nop</pre>

<p>/* case FFI_TYPE_DOUBLE  */ Lret_type3:</p>

<pre>lfd     f1,0(r5)
b       Lfinish
nop
nop</pre>

<p>/* case FFI_TYPE_LONGDOUBLE  */ Lret_type4:</p>

<pre>lfd     f1,0(r5)
lfd     f2,8(r5)
b       Lfinish
nop</pre>

<p>/* case FFI_TYPE_UINT8  */ Lret_type5: if defined(<em>ppc64</em>)</p>

<pre>lbz     r3,7(r5)</pre>

<p>else</p>

<pre>lbz     r3,3(r5)</pre>

<p>endif</p>

<pre>b       Lfinish
nop
nop</pre>

<p>/* case FFI_TYPE_SINT8  */ Lret_type6: if defined(<em>ppc64</em>)</p>

<pre>lbz     r3,7(r5)</pre>

<p>else</p>

<pre>lbz     r3,3(r5)</pre>

<p>endif</p>

<pre>extsb   r3,r3
b       Lfinish
nop</pre>

<p>/* case FFI_TYPE_UINT16  */ Lret_type7: if defined(<em>ppc64</em>)</p>

<pre>lhz     r3,6(r5)</pre>

<p>else</p>

<pre>lhz     r3,2(r5)</pre>

<p>endif</p>

<pre>b       Lfinish
nop
nop</pre>

<p>/* case FFI_TYPE_SINT16  */ Lret_type8: if defined(<em>ppc64</em>)</p>

<pre>lha     r3,6(r5)</pre>

<p>else</p>

<pre>lha     r3,2(r5)</pre>

<p>endif</p>

<pre>b       Lfinish
nop
nop</pre>

<p>/* case FFI_TYPE_UINT32  */ Lret_type9: if defined(<em>ppc64</em>)</p>

<pre>lwz     r3,4(r5)</pre>

<p>else</p>

<pre>lwz     r3,0(r5)</pre>

<p>endif</p>

<pre>b       Lfinish
nop
nop</pre>

<p>/* case FFI_TYPE_SINT32  */ Lret_type10: if defined(<em>ppc64</em>)</p>

<pre>lwz     r3,4(r5)</pre>

<p>else</p>

<pre>lwz     r3,0(r5)</pre>

<p>endif</p>

<pre>b       Lfinish
nop
nop</pre>

<p>/* case FFI_TYPE_UINT64  */ Lret_type11: if defined(<em>ppc64</em>)</p>

<pre>lg      r3,0(r5)
b       Lfinish
nop</pre>

<p>else</p>

<pre>lwz     r3,0(r5)
lwz     r4,4(r5)
b       Lfinish</pre>

<p>endif</p>

<pre>nop</pre>

<p>/* case FFI_TYPE_SINT64  */ Lret_type12: if defined(<em>ppc64</em>)</p>

<pre>lg      r3,0(r5)
b       Lfinish
nop</pre>

<p>else</p>

<pre>lwz     r3,0(r5)
lwz     r4,4(r5)
b       Lfinish</pre>

<p>endif</p>

<pre>nop</pre>

<p>/* case FFI_TYPE_STRUCT  */ Lret_type13: if defined(<em>ppc64</em>)</p>

<pre>lg      r3,0(r5)                ; we need at least this...
cmpi    0,r0,4
bgt     Lstructend              ; not a special small case
b       Lsmallstruct            ; see if we need more.</pre>

<p>else</p>

<pre>cmpi    0,r0,4
bgt     Lfinish         ; not by value
lg      r3,0(r5)
b       Lfinish</pre>

<p>endif /* case FFI_TYPE_POINTER  */ Lret_type14:</p>

<pre>lg      r3,0(r5)
b       Lfinish
nop
nop</pre>

<p>if defined(<em>ppc64</em>) Lsmallstruct:</p>

<pre>beq     Lfour                   ; continuation of Lret13.
cmpi    0,r0,3
beq     Lfinish                 ; don`t adjust this - can`t be any floats here...
srdi    r3,r3,48
cmpi    0,r0,2
beq     Lfinish                 ; .. or here ..
srdi    r3,r3,8
b       Lfinish                 ; .. or here.</pre>

<p>Lfour:</p>

<pre>lg      r6,LINKAGE_SIZE(r1)     ; get the result type
lg      r6,FFI_TYPE_ELEM(r6)    ; elements array pointer
lg      r6,0(r6)                ; first element
lhz     r0,FFI_TYPE_TYPE(r6)    ; OK go the type
cmpi    0,r0,2                  ; FFI_TYPE_FLOAT
bne     Lfourint
lfs     f1,0(r5)                ; just one float in the struct.
b       Lfinish</pre>

<p>Lfourint:</p>

<pre>srdi    r3,r3,32                ; four bytes.
b       Lfinish</pre>

<p>Lstructend:</p>

<pre>lg      r3,LINKAGE_SIZE(r1)     ; get the result type
bl      STRUCT_RETVALUE_P
cmpi    0,r3,0
beq     Lfinish                 ; nope.
/* Recover a pointer to the results.  */
addi    r11,r1,(SAVE_SIZE-RESULT_BYTES)
lg      r3,0(r11)               ; we need at least this...
lg      r4,8(r11)
cmpi    0,r0,16
beq     Lfinish         ; special case 16 bytes we don&#39;t consider floats.

/* OK, frustratingly, the process of saving the struct to mem might have
   messed with the FPRs, so we have to re-load them :(.
   We`ll use our FPRs space again - calling: 
   void darwin64_pass_struct_floats (ffi_type *s, char *src, 
                                     unsigned *nfpr, double **fprs) 
   We`ll temporarily pinch the first two slots of the param area for local
   vars used by the routine.  */
xor     r6,r6,r6
addi    r5,r1,PARENT_PARM_BASE          ; some space
sg      r6,0(r5)                        ; *nfpr zeroed.
addi    r6,r5,8                         ; **fprs
addi    r3,r1,FP_SAVE_BASE              ; pointer to FPRs space
sg      r3,0(r6)
mr      r4,r11                          ; the struct is here...
lg      r3,LINKAGE_SIZE(r1)             ; ffi_type * result_type.
bl      PASS_STR_FLOATS                 ; get struct floats into FPR save space.
/* See if we used any floats  */
lwz     r0,(SAVE_SIZE-RESULT_BYTES)(r1) 
cmpi    0,r0,0
beq     Lstructints                     ; nope.
/* OK load `em up... */
lfd     f1, (FP_SAVE_BASE                 )(r1)
lfd     f2, (FP_SAVE_BASE +  FPR_SIZE     )(r1)
lfd     f3, (FP_SAVE_BASE +  FPR_SIZE * 2 )(r1)
lfd     f4, (FP_SAVE_BASE +  FPR_SIZE * 3 )(r1)
lfd     f5, (FP_SAVE_BASE +  FPR_SIZE * 4 )(r1)
lfd     f6, (FP_SAVE_BASE +  FPR_SIZE * 5 )(r1)
lfd     f7, (FP_SAVE_BASE +  FPR_SIZE * 6 )(r1)
lfd     f8, (FP_SAVE_BASE +  FPR_SIZE * 7 )(r1)
lfd     f9, (FP_SAVE_BASE +  FPR_SIZE * 8 )(r1)
lfd     f10,(FP_SAVE_BASE +  FPR_SIZE * 9 )(r1)
lfd     f11,(FP_SAVE_BASE +  FPR_SIZE * 10)(r1)
lfd     f12,(FP_SAVE_BASE +  FPR_SIZE * 11)(r1)
lfd     f13,(FP_SAVE_BASE +  FPR_SIZE * 12)(r1)

/* point back at our saved struct.  */</pre>

<p>Lstructints:</p>

<pre>addi    r11,r1,(SAVE_SIZE-RESULT_BYTES)
lg      r3,0(r11)                       ; we end up picking the
lg      r4,8(r11)                       ; first two again.
lg      r5,16(r11)
lg      r6,24(r11)
lg      r7,32(r11)
lg      r8,40(r11)
lg      r9,48(r11)
lg      r10,56(r11)</pre>

<p>endif</p>

<p>/* case done  */ Lfinish:</p>

<pre>addi    r1,r1,SAVE_SIZE         /* Restore stack pointer.  */
lg      r0,SAVED_LR_OFFSET(r1)  /* Get return address.  */
mtlr    r0                      /* Reset link register.  */
blr</pre>

<p>Lendcode:</p>

<pre>.align 1</pre>

<p>/* END(ffi_closure_ASM)  */</p>

<p>/* EH frame stuff.  */ define EH_DATA_ALIGN_FACT MODE_CHOICE(0x7c,0x78) /*
176, 400 */ define EH_FRAME_OFFSETA MODE_CHOICE(176,0x90) define
EH_FRAME_OFFSETB MODE_CHOICE(1,3)</p>

<pre>.static_data
.align LOG2_GPR_BYTES</pre>

<p>LLFB1$non_lazy_ptr:</p>

<pre>.g_long Lstartcode

.section __TEXT,__eh_frame,coalesced,no_toc+strip_static_syms+live_support</pre>

<p>EH_frame1:</p>

<pre>.set    L$set$0,LECIE1-LSCIE1
.long   L$set$0 ; Length of Common Information Entry</pre>

<p>LSCIE1:</p>

<pre>.long   0x0     ; CIE Identifier Tag
.byte   0x1     ; CIE Version
.ascii  &quot;zR\0&quot;  ; CIE Augmentation
.byte   0x1     ; uleb128 0x1; CIE Code Alignment Factor
.byte   EH_DATA_ALIGN_FACT ; sleb128 -4; CIE Data Alignment Factor
.byte   0x41    ; CIE RA Column
.byte   0x1     ; uleb128 0x1; Augmentation size
.byte   0x10    ; FDE Encoding (indirect pcrel)
.byte   0xc     ; DW_CFA_def_cfa
.byte   0x1     ; uleb128 0x1
.byte   0x0     ; uleb128 0x0
.align  LOG2_GPR_BYTES</pre>

<p>LECIE1:</p>

<pre>.globl _ffi_closure_ASM.eh</pre>

<p>_ffi_closure_ASM.eh: LSFDE1:</p>

<pre>.set    L$set$1,LEFDE1-LASFDE1
.long   L$set$1 ; FDE Length</pre>

<p>LASFDE1:</p>

<pre>.long   LASFDE1-EH_frame1       ; FDE CIE offset
.g_long LLFB1$non_lazy_ptr-.    ; FDE initial location
.set    L$set$3,LFE1-Lstartcode
.g_long L$set$3 ; FDE address range
.byte   0x0     ; uleb128 0x0; Augmentation size
.byte   0x4     ; DW_CFA_advance_loc4
.set    L$set$3,LCFI1-LCFI0
.long   L$set$3
.byte   0xe     ; DW_CFA_def_cfa_offset
.byte   EH_FRAME_OFFSETA,EH_FRAME_OFFSETB       ; uleb128 176,1/190,3
.byte   0x4     ; DW_CFA_advance_loc4
.set    L$set$4,LCFI0-Lstartcode
.long   L$set$4
.byte   0x11    ; DW_CFA_offset_extended_sf
.byte   0x41    ; uleb128 0x41
.byte   0x7e    ; sleb128 -2
.align  LOG2_GPR_BYTES</pre>

<p>LEFDE1:</p>

<pre>.align  1</pre>

<p>ifdef WANT_STUB</p>

<pre>.section __TEXT,__picsymbolstub1,symbol_stubs,pure_instructions,32
.align 5</pre>

<p>L_ffi_closure_helper_DARWIN$stub:</p>

<pre>.indirect_symbol _ffi_closure_helper_DARWIN
mflr r0
bcl 20,31,&quot;L00000000001$spb&quot;</pre>

<p>“L00000000001$spb”:</p>

<pre>mflr r11
addis r11,r11,ha16(L_ffi_closure_helper_DARWIN$lazy_ptr-&quot;L00000000001$spb&quot;)
mtlr r0
lwzu r12,lo16(L_ffi_closure_helper_DARWIN$lazy_ptr-&quot;L00000000001$spb&quot;)(r11)
mtctr r12
bctr
.lazy_symbol_pointer</pre>

<p>L_ffi_closure_helper_DARWIN$lazy_ptr:</p>

<pre>.indirect_symbol _ffi_closure_helper_DARWIN
.long   dyld_stub_binding_helper</pre>

<p>if defined(<em>ppc64</em>)</p>

<pre>.section __TEXT,__picsymbolstub1,symbol_stubs,pure_instructions,32
.align 5</pre>

<p>L_darwin64_struct_ret_by_value_p$stub:</p>

<pre>.indirect_symbol _darwin64_struct_ret_by_value_p
mflr r0
bcl 20,31,&quot;L00000000002$spb&quot;</pre>

<p>“L00000000002$spb”:</p>

<pre>mflr r11
addis r11,r11,ha16(L_darwin64_struct_ret_by_value_p$lazy_ptr-&quot;L00000000002$spb&quot;)
mtlr r0
lwzu r12,lo16(L_darwin64_struct_ret_by_value_p$lazy_ptr-&quot;L00000000002$spb&quot;)(r11)
mtctr r12
bctr
.lazy_symbol_pointer</pre>

<p>L_darwin64_struct_ret_by_value_p$lazy_ptr:</p>

<pre>.indirect_symbol _darwin64_struct_ret_by_value_p
.long   dyld_stub_binding_helper
.section __TEXT,__picsymbolstub1,symbol_stubs,pure_instructions,32
.align 5</pre>

<p>L_darwin64_pass_struct_floats$stub:</p>

<pre>.indirect_symbol _darwin64_pass_struct_floats
mflr r0
bcl 20,31,&quot;L00000000003$spb&quot;</pre>

<p>“L00000000003$spb”:</p>

<pre>mflr r11
addis r11,r11,ha16(L_darwin64_pass_struct_floats$lazy_ptr-&quot;L00000000003$spb&quot;)
mtlr r0
lwzu r12,lo16(L_darwin64_pass_struct_floats$lazy_ptr-&quot;L00000000003$spb&quot;)(r11)
mtctr r12
bctr
.lazy_symbol_pointer</pre>

<p>L_darwin64_pass_struct_floats$lazy_ptr:</p>

<pre>.indirect_symbol _darwin64_pass_struct_floats
.long   dyld_stub_binding_helper</pre>

<p>#  endif endif</p>

</div>



<footer id="validator-badges">
  <p><a href="http://validator.w3.org/check/referer">[Validate]</a>
  <p>Generated by <a href="https://github.com/rdoc/rdoc">RDoc</a> 4.0.0.
  <p>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish Rdoc Generator</a> 3.
</footer>

